<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />
    <title>HABSIM: High Altitude Balloon Simulator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0; overflow-y: hidden;  }

        #info {

            width: 100%;
            height: 180px;
            /* bottom: 0px; */
            /* right: 0px; */
            top: 0px;
            background-color: #111;
            color: #a2a2a2;
            font-family: Helvetica;
            font-size: 1vw;

        }

        #map{
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .nav-item {
            padding-right: 35px;
        }

        .input {
            padding-bottom: 5px;
        }

        #navbarSupportedContent {
            margin-top: 5px;
        }

        .radio-inline {
            margin-right: 5px;
        }

        .radiobtn {
            margin-right: 5px;
        }
        @media (max-width: 768px) {
            #info {
                overflow-y: scroll;
                overflow-x: scroll;
            }

            body{
                overflow-y: scroll;
            }
        }

        .toggle {
            border: solid 1px #a2a2a2;
        }

    </style>
</head>
<body>
<!--<div id="info" style="padding-left:2ch; padding-right: 2ch">
    <div>
        <h1>Stanford SSI HABSIM</h1>
        <h2>Standard-profile trajectory prediction</h2>
        Model run: <span id="run">Unavailable</span></br>
        Server status: <span id="status">Unavailable</span></br></br>
        </div>
    <div>



        <b>Click to select. </b></br>




        <br/><br/>
        If no trajectories appear, please check that the trajectory end time is within 384 hours of the model run.
    </div>-->

<nav id="info" class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#"><img src="https://s3-us-west-1.amazonaws.com/habmc/assets/Logo_BlackSubText.png" style="width: 120px;"></a>

    <div  id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">

            <li class="nav-item" style="width: 20%">
                <a class="navbar-brand" href="#">Stanford SSI HABSIM</a><br>

                <label class="radio-inline"><input type="radio" name="optradio" class="radiobtn" value="standardbln" checked>Standard</label>
                <label class="radio-inline"><input type="radio" name="optradio" class="radiobtn" value="zpbbln">ZPB</label>
                <label class="radio-inline"><input type="radio" name="optradio" class="radiobtn" value="floatbln" >Float</label>
                <label class="switch">Waypoints:
                    <input id="toggle-event" type="checkbox" checked data-toggle="toggle" data-on="Enabled" data-off="Disabled" data-size="small" data-onstyle="success">
                </label>

            </li>
            <li class="nav-item" style="width: 15%">
                <div class = "input">
                    Date: <input id = "yr" type="text" size="4" name="yr">/<input id = "mo" type="text" size="2" name="mo">/<input id = "day" type="text" size="2" name="day"><br/>
                </div>
                <div class = "input">
                    Time (UTC): <input id = "hr" type="text" size="2" name="hr">:<input id = "mn" type="text" size="2" name="mn"><br/><br/>
                </div>
            </li>
            <li class="nav-item">
                <div class = "input">
                    Lat: <input id="lat" type="text" size="8" name="lat"> <br/>
                </div>
                <div class = "input">
                    Lon: <input id="lon" type="text" size="8" name="2lon"> <br/>
                </div>
                <p style="
    font-size: 12px;
">Click on map to get coordinates
                </p>

            </li>
            <li class="nav-item">
                <div class = "input">
                    Launch altitude: <input id="alt" type="text" size="5" name="alt"> m <br/>
                </div>
                <button class="btn-sm" onclick="getElev()">Get Ground Elevation</button>
            </li>
            <li class="nav-item" id = "contentwrap">
                <div class = "input">
                    Ascent rate: <input id="asc" type="text" size="4" name="asc"> m/s <br/>
                </div>
                <div class = "input">
                    Burst altitude: <input id="equil" type="text" size="5" name="equil"> m <br/>
                </div>
                <div class = "input">
                    Descent rate: <input id="desc" type="text" size="4" name="desc"> m/s <br/>
                </div>
            </li>
            <li class="nav-item" style="width: 15%">
                <div class = "input">
                    Model run: <span id="run">Unavailable</span></br>
                </div>
                <div class = "input">
                    Server status: <span id="status">Unavailable</span></br>
                </div>
                <div class = "input">
                    <button class="btn-sm btn-info" onclick="simulate()">Simulate</button> <br/>
                </div>
            </li>
        </ul>
    </div>

</nav>
</div>
<div id="map" style="float: left;"></div>
<!-- bring in the google maps library -->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
    var btype = "STANDARD"
    $(document).ready(function() {
        $('input[name="optradio"]').on('change', function () {

            if ($(this).val() === "standardbln") {
                var codeBlock = "<div class = \"input\">\n" +
                    "                Ascent rate: <input id=\"asc\" type=\"text\" size=\"4\" name=\"asc\"> m/s <br/>\n" +
                    "                </div>\n" +
                    "                <div class = \"input\">\n" +
                    "                Burst altitude: <input id=\"equil\" type=\"text\" size=\"5\" name=\"equil\"> m <br/>\n" +
                    "                </div>\n" +
                    "                <div class = \"input\">\n" +
                    "                Descent rate: <input id=\"desc\" type=\"text\" size=\"4\" name=\"desc\"> m/s <br/>\n" +
                    "                </div>"
                document.getElementById("contentwrap").innerHTML = codeBlock;
                document.getElementById("asc").value = 4;
                document.getElementById("equil").value = 30000;
                document.getElementById("desc").value = 8;
                btype = "STANDARD"
            }

            else if ($(this).val() === "zpbbln") {
                var codeBlock = "<div class = \"input\">\n" +
                    "                Ascent rate: <input id=\"asc\" type=\"text\" size=\"4\" name=\"asc\"> m/s <br/>\n" +
                    "                </div>\n" +
                    "                <div class = \"input\">\n" +
                    "                Equilibrium altitude: <input id=\"equil\" type=\"text\" size=\"5\" name=\"equil\"> m <br/>\n" +
                    "                </div>\n" + "<div class = \"input\">\n" +
                    "                Time at Equilibrium: <input id=\"eqtime\" type=\"text\" size=\"4\" name=\"eqtime\"> h <br/>\n" +
                    "                </div>\n" +
                    "                <div class = \"input\">\n" +
                    "                Descent rate: <input id=\"desc\" type=\"text\" size=\"4\" name=\"desc\"> m/s <br/>\n" +
                    "                </div>"
                document.getElementById("contentwrap").innerHTML = codeBlock;
                document.getElementById("asc").value = 3.7;
                document.getElementById("equil").value = 29000;
                document.getElementById("eqtime").value = 1;
                document.getElementById("desc").value = 15;
                btype = "ZPB"


            } else if ($(this).val() === "floatbln") {
                var codeBlock = "<div class = \"input\">\n" +
                    "                Floating Coefficient: <input id=\"coeff\" type=\"text\" size=\"4\" name=\"coeff\"> <br/>\n" +
                    "                </div>\n" +
                    "                <div class = \"input\">\n" +
                    "                Simulate for: <input id=\"dur\" type=\"text\" size=\"4\" name=\"dur\"> h <br/>\n" +
                    "                </div>\n" +
                    "                <div class = \"input\">\n" +
                    "                Step Size: <input id=\"step\" type=\"text\" size=\"4\" name=\"step\"> m/s <br/>\n" +
                    "                </div>"
                document.getElementById("contentwrap").innerHTML = codeBlock;
                document.getElementById("coeff").value = 0.5;
                document.getElementById("dur").value = 48;
                document.getElementById("step").value = 240;
                btype = "FLOAT"

            }
        });
    });
    var waypointsToggle = true;
    $(function() {
        $('#toggle-event').change(function() {
            var state = $(this).prop('checked');
            if(!state){
                waypointsToggle = false
                clearWaypoints();
            }
            else{
                waypointsToggle = true;
                simulate()
            }
        })
    })
    var currpaths = new Array()
    async function simulate() {
        clearWaypoints();
        for (path in currpaths) {
            currpaths[path].setMap(null);
        }
        currpaths = new Array();
        console.log("Clearing");
        var time = toTimestamp(Number(document.getElementById('yr').value),
            Number(document.getElementById('mo').value),
            Number(document.getElementById('day').value),
            Number(document.getElementById('hr').value),
            Number(document.getElementById('mn').value));
        var lat = document.getElementById('lat').value;
        var lon = document.getElementById('lon').value;
        var alt = document.getElementById('alt').value;
        var url = ""
        switch(btype) {
            case 'STANDARD':
                // code block
                var equil = document.getElementById('equil').value;
                var asc = document.getElementById('asc').value;
                var desc = document.getElementById('desc').value;
                url = "https://predict.stanfordssi.org/singlezpb?timestamp="
                    + time + "&lat=" + lat + "&lon=" + lon + "&alt=" + alt + "&equil=" + equil + "&eqtime=" + 0 + "&asc=" + asc + "&desc=" + desc;

                break;
            case 'ZPB':
                // code block
                var equil = document.getElementById('equil').value;
                var eqtime = document.getElementById('eqtime').value;
                var asc = document.getElementById('asc').value;
                var desc = document.getElementById('desc').value;
                url = "https://predict.stanfordssi.org/singlezpb?timestamp="
                    + time + "&lat=" + lat + "&lon=" + lon + "&alt=" + alt + "&equil=" + equil + "&eqtime=" + eqtime + "&asc=" + asc + "&desc=" + desc

                break;
            case 'FLOAT':
                // code block
                var coeff = document.getElementById('coeff').value;
                var step = document.getElementById('step').value;
                var dur = document.getElementById('dur').value;
                url = "https://predict.stanfordssi.org/singlepredict?timestamp="
                    + time + "&lat=" + lat + "&lon=" + lon + "&alt=" + alt + "&rate=0&coeff=" + coeff + "&step=" + step + "&dur=" + dur

                break;
        }


        for (i = 1; i < 21; i++) {
            var url2 = url + "&model=" + i;
            console.log(url2);
            await fetch(url2).then(res => res.json()).then(resjson => showpath(resjson));
        }


    }
    circleslist = [];
    function showpath(path) {
        switch(btype) {
            case 'STANDARD':
                var rise = path[0];
                var equil = []
                var fall = path[2];
                var fpath = [];

                break;
            case 'ZPB':
                var rise = path[0];
                var equil = path[1]
                var fall = path[2];
                var fpath = [];
                break;
            // This doesn't work

            case 'FLOAT':
                var rise = [];
                var equil = [];
                var fall = [];
                var fpath = path;
        }
        var allpaths = [rise, equil, fall, fpath];
        makepaths(btype, allpaths);

    }

    function getcolor(index){
        switch(index){
            case '0':
                return '#DC143C';
            case '1':
                return '#0000FF';
            case '2':
                return '#000000';
            case '3': return '#000000';
        }
    }
    function makepaths(btype, allpaths){
        for (index in allpaths) {
            var pathpoints = [];
            for (point in allpaths[index]){
                (function () {
                    var position = {
                        lat: allpaths[index][point][1],
                        lng: allpaths[index][point][2],
                    };
                    pathpoints.push(position);
                    if(waypointsToggle){
                        var circle = new google.maps.Circle({
                            strokeColor: getcolor(index),
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: getcolor(index),
                            fillOpacity: 0.35,
                            map: map,
                            center: position,
                            radius: 300,
                            clickable: true
                        });
                        circleslist.push(circle);
                        // multiplied by 1000 so that the argument is in milliseconds, not seconds.
                        var date = new Date(allpaths[index][point][0] * 1000);
                        // Hours part from the timestamp
                        var hours = date.getHours();
                        // Minutes part from the timestamp
                        var minutes = "0" + date.getMinutes();
                        // Seconds part from the timestamp
                        var seconds = "0" + date.getSeconds();

                        // Will display time in 10:30:23 format
                        var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
                        var infowindow = new google.maps.InfoWindow({
                            content: "Altitude: " + allpaths[index][point][3] + "m \n \n \n Time: " + formattedTime
                        });
                        circle.addListener("mouseover", function () {
                            infowindow.setPosition(circle.getCenter());
                            infowindow.open(map);
                        });
                        circle.addListener("mouseout", function () {
                            infowindow.close(map);
                        });
                    }

                }());
            }
            var drawpath = new google.maps.Polyline({
                path: pathpoints,
                geodesic: true,
                strokeColor: getcolor(index),
                strokeOpacity: 1.0,
                strokeWeight: 2
            });
            drawpath.setMap(map);
            currpaths.push(drawpath);
        }

    }


    function clearWaypoints() {
        //Loop through all the markers and remove
        for (var i = 0; i < circleslist.length; i++) {
            circleslist[i].setMap(null);
        }
        circleslist = [];
    }

    window.onload = function(){
        fetch("https://predict.stanfordssi.org/status").then(res => res.text()).then((result) => {
            document.getElementById("status").textContent = result;
            if(result === "Ready") {
                document.getElementById("status").style.color = "#00CC00";
            }
            else if(result === "Unavailable" || result === "Initializing. Please check again later."){
                document.getElementById("status").style.color = "#CC0000";
            }
            else{
                document.getElementById("status").style.color = "#FFB900";
            }

        });



    }();
</script>
<div id="map_canvas" style="width:80%; height:100%"></div>
<script>
    document.getElementById("asc").value = 4;
    document.getElementById("equil").value = 30000;
    document.getElementById("desc").value = 8;
</script>
<script type="text/javascript" src = "common.js"></script>


</body>