<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />
    <title>HABSIM: High Altitude Balloon Simulator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }

        #info {

            width: 100%;
            height: 130px;
            /* bottom: 0px; */
            /* right: 0px; */
            overflow-y: scroll;
            overflow-x: scroll;
            top: 0px;
            background-color: #111;
            color: #a2a2a2;
            font-family: Helvetica;

        }

        #map{
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .nav-item {
            padding-right: 40px;
        }

        .input {
            padding-bottom: 5px;
        }

        #navbarSupportedContent {
            margin-top: 5px;
        }
    </style>
</head>
<body>
<!--<div id="info" style="padding-left:2ch; padding-right: 2ch">
    <div>
        <h1>Stanford SSI HABSIM</h1>
        <h2>Standard-profile trajectory prediction</h2>
        Model run: <span id="run">Unavailable</span></br>
        Server status: <span id="status">Unavailable</span></br></br>
        </div>
    <div>



        <b>Click to select. </b></br>




        <br/><br/>
        If no trajectories appear, please check that the trajectory end time is within 384 hours of the model run.
    </div>-->

<nav id="info" class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#"><img src="https://s3-us-west-1.amazonaws.com/habmc/assets/Logo_BlackSubText.png" style="width: 120px;"></a>

    <div  id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">

            <li class="nav-item">
                <a class="navbar-brand" href="#">Stanford SSI HABSIM</a><br>
                <p>Standard-profile trajectory prediction</p>
            </li>
            <li class="nav-item">
                <div class = "input">
                Date: <input id = "yr" type="text" size="4" name="yr">/<input id = "mo" type="text" size="2" name="mo">/<input id = "day" type="text" size="2" name="day"><br/>
                </div>
                <div class = "input">
                    Time (UTC): <input id = "hr" type="text" size="2" name="hr">:<input id = "mn" type="text" size="2" name="mn"><br/><br/>
                </div>
            </li>
            <li class="nav-item">
                <div class = "input">
                Lat: <input id="lat" type="text" size="8" name="lat"> <br/>
                </div>
                <div class = "input">
                Lon: <input id="lon" type="text" size="8" name="2lon"> <br/>
                </div>

            </li>
            <li class="nav-item">
                <div class = "input">
                Launch altitude: <input id="alt" type="text" size="5" name="alt"> m <br/>
                </div>
                <button onclick="getElev()">Ground elevation</button>
            </li>
            <li class="nav-item">
                <div class = "input">
                Ascent rate: <input id="asc" type="text" size="4" name="asc"> m/s <br/>
                </div>
                <div class = "input">
                Burst altitude: <input id="equil" type="text" size="4" name="equil"> m <br/>
                </div>
                <div class = "input">
                Descent rate: <input id="desc" type="text" size="4" name="desc"> m/s <br/>
                </div>
            </li>
            <li class="nav-item">
                <div class = "input">
                Model run: <span id="run">Unavailable</span></br>
                </div>
                <div class = "input">
                Server status: <span id="status">Unavailable</span></br>
                </div>
                <div class = "input">
                <button onclick="simulate()">Simulate</button> <br/>
                </div>
            </li>
        </ul>
    </div>

</nav>
</div>
<div id="map" style="float: left;"></div>
<!-- bring in the google maps library -->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
    var currpaths = new Array()
    async function simulate() {
        clearMap();
        for (path in currpaths) {
            currpaths[path].setMap(null);
        }
        currpaths = new Array();
        console.log("Clearing");
        var time = toTimestamp(Number(document.getElementById('yr').value),
            Number(document.getElementById('mo').value),
            Number(document.getElementById('day').value),
            Number(document.getElementById('hr').value),
            Number(document.getElementById('mn').value));
        var lat = document.getElementById('lat').value;
        var lon = document.getElementById('lon').value;
        var alt = document.getElementById('alt').value;
        var equil = document.getElementById('equil').value;
        var asc = document.getElementById('asc').value;
        var desc = document.getElementById('desc').value;

        for (i = 1; i < 21; i++) {
            var url = "https://predict.stanfordssi.org/singlezpb?timestamp="
                + time + "&lat=" + lat + "&lon=" + lon + "&alt=" + alt + "&equil=" + equil + "&eqtime=" + 0 + "&asc=" + asc + "&desc=" + desc
                + "&model=" + i
            console.log(url);
            await fetch(url).then(res => res.json()).then(resjson => showpath(resjson));
        }

    }
    circleslist = [];
    function showpath(path) {

        var rise = path[0];
        var fall = path[2];
        var risepathpoints = [];
        for (point in rise) {
            (function () {

                risepathpoints.push({
                    lat: rise[point][1],
                    lng: rise[point][2],
                });
                var circle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.35,
                    map: map,
                    center: {lat: rise[point][1], lng: rise[point][2]},
                    radius: 300,
                    clickable: true
                });
                circleslist.push(circle)
                var infowindow = new google.maps.InfoWindow({
                    content: "Altitude: " + rise[point][3] + " m \n \n \n Time: " + rise[point][0]
                });
                circle.addListener("mouseover", function () {
                    infowindow.setPosition(circle.getCenter());
                    infowindow.open(map);
                });
                circle.addListener("mouseout", function () {
                    infowindow.close(map);
                });

            }());

        }
        var risepath = new google.maps.Polyline({
            path: risepathpoints,
            geodesic: true,
            strokeColor: '#DC143C',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });
        risepath.setMap(map);
        currpaths.push(risepath);

        var fallpathpoints = [];
        for (point in fall) {
            (function () {

                fallpathpoints.push({
                    lat: fall[point][1],
                    lng: fall[point][2],
                });
                var circle = new google.maps.Circle({
                    strokeColor: '#000000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#000000',
                    fillOpacity: 0.35,
                    map: map,
                    center: {lat: fall[point][1], lng: fall[point][2]},
                    radius: 300,
                    clickable: true
                });
                circleslist.push(circle)
                var infowindow = new google.maps.InfoWindow({
                    content: "Altitude: " + fall[point][3] + "m \n \n \n Time: " + fall[point][0]
                });
                circle.addListener("mouseover", function () {
                    infowindow.setPosition(circle.getCenter());
                    infowindow.open(map);
                });
                circle.addListener("mouseout", function () {
                    infowindow.close(map);
                });
            }());
        }
        var fallpath = new google.maps.Polyline({
            path: fallpathpoints,
            geodesic: true,
            strokeColor: '#000000',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });

        fallpath.setMap(map);
        currpaths.push(fallpath);



    }

    function clearMap() {
        //Loop through all the markers and remove
        for (var i = 0; i < circleslist.length; i++) {
            circleslist[i].setMap(null);
        }
        circleslist = [];
    }
</script>
<div id="map_canvas" style="width:80%; height:100%"></div>

<script type="text/javascript" src = "common.js"></script>

<script>
    document.getElementById("asc").value = 4
    document.getElementById("equil").value = 30000
    document.getElementById("desc").value = 8
</script>
</body>